<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Keep Team">
    
    <title>
        
            SharedPreferences源码分析 |
        
        Keep Theme
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/logo.svg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"example.com","root":"/","language":"en"};
    KEEP.theme_config = {"toc":{"enable":false,"number":false,"expand_all":false,"init_open":false},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.svg","favicon":"/images/logo.svg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":false,"scale":false},"first_screen":{"enable":false,"background_img":"/images/bg.svg","description":"Keep writing and Keep loving."},"scroll":{"progress_bar":{"enable":false},"percent":{"enable":false}}},"local_search":{"enable":false,"preload":false},"code_copy":{"enable":false,"style":"default"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.5"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
<meta name="generator" content="Hexo 6.1.0"></head>


<body>
<div class="progress-bar-container">
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                Keep Theme
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                    
                </ul>
            </div>
            <div class="mobile">
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">SharedPreferences源码分析</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.svg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Keep Team</span>
                        
                            <span class="author-label">Lv3</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;
        <span class="pc">2020-03-18 00:51:11</span>
        <span class="mobile">2020-03-18 00:51</span>
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/Android/">Android</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/Android/">Android</a>&nbsp;
                    </li>
                
                    <li>
                        | <a href="/tags/SharedPreferences/">SharedPreferences</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
    
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h3 id="分析哪些内容："><a href="#分析哪些内容：" class="headerlink" title="分析哪些内容："></a>分析哪些内容：</h3><ul>
<li>Sp是如何构造的</li>
<li>SP线程安全是如何实现的</li>
<li>commit与apply的区别</li>
<li>sp在内存中的存储数据结</li>
</ul>
<hr>
<h3 id="SharedPreferences构造"><a href="#SharedPreferences构造" class="headerlink" title="SharedPreferences构造"></a>SharedPreferences构造</h3><p>Context类中有</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> SharedPreferences <span class="title function_">getSharedPreferences</span><span class="params">(String name, <span class="meta">@PreferencesMode</span> <span class="type">int</span> mode)</span>;</span><br></pre></td></tr></table></figure>

<p>name:SharedPreference的名字<br>mode:模式</p>
<blockquote>
<p>MODE_PRIVATE文件创建模式：默认模式，在此模式下，调用的应用程序（或共享*同一用户ID的所有应用程序）只能访问创建的文件</p>
</blockquote>
<blockquote>
<p>MODE_APPEND: 文件创建模式：与{@link #openFileOutput}一起使用，如果文件<em>已经存在，则将数据写入现有文件的末尾</em>而不是擦除它。</p>
</blockquote>
<p><strong>getSharedPreference源码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> SharedPreferences <span class="title function_">getSharedPreferences</span><span class="params">(String name, <span class="type">int</span> mode)</span> &#123;</span><br><span class="line">    SharedPreferencesImpl sp;			<span class="comment">//Impl是SP的实现类</span></span><br><span class="line">    <span class="keyword">synchronized</span> (ContextImpl.class) &#123; <span class="comment">//上锁保证线程安全 </span></span><br><span class="line">        <span class="keyword">if</span> (sSharedPrefs == <span class="literal">null</span>) &#123;</span><br><span class="line">            sSharedPrefs = <span class="keyword">new</span> <span class="title class_">ArrayMap</span>&lt;String, ArrayMap&lt;String, SharedPreferencesImpl&gt;&gt;(); <span class="comment">//这个数据结构,ArrayMap&lt;String,ArrayMap&lt;String,SharedPreferences&gt;&gt;</span></span><br><span class="line">            																	<span class="comment">//先根据&quot;包名&quot;的名字找到对应的SpArrayMap ,    内层的ArrayMap用来取对应的Sp文件</span></span><br><span class="line">            																	</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">String</span> <span class="variable">packageName</span> <span class="operator">=</span> getPackageName();			<span class="comment">//获得当前包名</span></span><br><span class="line">        ArrayMap&lt;String, SharedPreferencesImpl&gt; packagePrefs = sSharedPrefs.get(packageName);</span><br><span class="line">        <span class="keyword">if</span> (packagePrefs == <span class="literal">null</span>) &#123;</span><br><span class="line">            packagePrefs = <span class="keyword">new</span> <span class="title class_">ArrayMap</span>&lt;String, SharedPreferencesImpl&gt;();</span><br><span class="line">            sSharedPrefs.put(packageName, packagePrefs);		</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// At least one application in the world actually passes in a null</span></span><br><span class="line">        <span class="comment">// name.  This happened to work because when we generated the file name</span></span><br><span class="line">        <span class="comment">// we would stringify it to &quot;null.xml&quot;.  Nice.</span></span><br><span class="line">        <span class="keyword">if</span> (mPackageInfo.getApplicationInfo().targetSdkVersion &lt;				<span class="comment">//SDK版本小于4.4(name可以为空)</span></span><br><span class="line">            <span class="keyword">if</span> (name == <span class="literal">null</span>) &#123;</span><br><span class="line">                name = <span class="string">&quot;null&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        sp = packagePrefs.get(name);				<span class="comment">//获得名字为name的Sp</span></span><br><span class="line">        <span class="keyword">if</span> (sp == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">File</span> <span class="variable">prefsFile</span> <span class="operator">=</span> getSharedPrefsFile(name); 	</span><br><span class="line">            sp = ne w <span class="title function_">SharedPreferencesImpl</span><span class="params">(prefsFile, mode)</span>;&lt;-----------------------记住这句话	<span class="comment">//若没名字为name的SharedPreferences,新建一个</span></span><br><span class="line">            packagePrefs.put(name, sp);					<span class="comment">// 放进ArraMap中.</span></span><br><span class="line">            <span class="keyword">return</span> sp;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        <span class="comment">/***</span></span><br><span class="line"><span class="comment">        这里很骚,如果要得到的sp文件没有,(第一次加载),下面的代码不会执行</span></span><br><span class="line"><span class="comment">        若你取的实例已经存在,就要先检查一下这个文件是不是被更改过了</span></span><br><span class="line"><span class="comment">        </span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> ((mode &amp; Context.MODE_MULTI_PROCESS) != <span class="number">0</span> ||			<span class="comment">//如果不是Mode_Private模式.</span></span><br><span class="line">        getApplicationInfo().targetSdkVersion &lt; android.os.Build.VERSION_CODES.HONEYCOMB) &#123;   <span class="comment">//HONEYCOMB 为Android 3.0</span></span><br><span class="line">        <span class="comment">// If somebody else (some other process) changed the prefs</span></span><br><span class="line">        <span class="comment">// file behind our back, we reload it.  This has been the 	</span></span><br><span class="line">        如果被修改过,重新加载(如何判断是否修改过:最后修改时间+文件的字节数是否相同)</span><br><span class="line">        <span class="comment">// historical (if undocumented) behavior.</span></span><br><span class="line">        sp.startReloadIfChangedUnexpectedly();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sp;</span><br><span class="line">&#125; &#125;</span><br></pre></td></tr></table></figure>

<p>这里面主要是看他的数据结构</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ArrayMap&lt;包名,ArrayMap&lt;name,SharedPreferenceImpl&gt;&gt;</span><br></pre></td></tr></table></figure>
<p>先根据包名找到对应的ArrayMap-&gt;根据name查找对应的Sp.</p>
<hr>
<blockquote>
<p>ArrayMap:</p>
</blockquote>
<ul>
<li>内存使用率高,特点:删除Item时,他会自动缩小数组(为了内存)</li>
<li>比 HashMap效率低</li>
<li>内部使用二分查找,它会将key的hask值进行排序.</li>
<li>当数据量过大的时候,他的效率会降低50%(解释了为什么数据量过大不使用SharedPreferences存储)</li>
</ul>
<hr>
<h3 id="看SharedPreferencesImpl"><a href="#看SharedPreferencesImpl" class="headerlink" title="看SharedPreferencesImpl:"></a>看SharedPreferencesImpl:</h3><p>前一段代码在没有实例后,会新建一个SharedPreferencesImpl并加入到ContextImpl中的ArrayMap</p>
<p>构造方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SharedPreferencesImpl(File file, <span class="type">int</span> mode) &#123;</span><br><span class="line">    mFile = file;</span><br><span class="line">    mBackupFile =<span class="keyword">new</span> <span class="title class_">makeBackupFile</span>(file);<span class="comment">//创建备份文件.内部实现</span></span><br><span class="line">    mMode = mode;</span><br><span class="line">    mLoaded = <span class="literal">false</span>;    <span class="comment">//标志,是否已经被加载了</span></span><br><span class="line">    mMap = <span class="literal">null</span>;</span><br><span class="line">    startLoadFromDisk();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>startLoadFromDisk()</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">startLoadFromDisk</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;           <span class="comment">//这里锁</span></span><br><span class="line">        mLoaded = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">Thread</span>(<span class="string">&quot;SharedPreferencesImpl-load&quot;</span>) &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (SharedPreferencesImpl.<span class="built_in">this</span>) &#123;</span><br><span class="line">                loadFromDiskLocked();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>开了个线程,调用loadFromDiskLocked();</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">loadFromDiskLocked</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (mLoaded) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (mBackupFile.exists()) &#123;		<span class="comment">//备份文件存在,删除源文件,将备份文件重命名</span></span><br><span class="line">           mFile.delete();				</span><br><span class="line">           mBackupFile.renameTo(mFile);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Debugging</span></span><br><span class="line">       <span class="keyword">if</span> (mFile.exists() &amp;&amp; !mFile.canRead()) &#123;	</span><br><span class="line">           Log.w(TAG, <span class="string">&quot;Attempt to read preferences file &quot;</span> + mFile + <span class="string">&quot; without permission&quot;</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">       <span class="type">StructStat</span> <span class="variable">stat</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           stat = Os.stat(mFile.getPath());</span><br><span class="line">           <span class="keyword">if</span> (mFile.canRead()) &#123;</span><br><span class="line">               <span class="type">BufferedInputStream</span> <span class="variable">str</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">               <span class="keyword">try</span> &#123;</span><br><span class="line">                   str = <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(</span><br><span class="line">                           <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(mFile), <span class="number">16</span>*<span class="number">1024</span>);</span><br><span class="line">                   map = XmlUtils.readMapXml(str);		<span class="comment">//读取SharedPreferences文件的内容并返回一个Map集合</span></span><br><span class="line">               &#125; <span class="keyword">catch</span> (XmlPullParserException e) &#123;</span><br><span class="line">                   Log.w(TAG, <span class="string">&quot;getSharedPreferences&quot;</span>, e);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">                   Log.w(TAG, <span class="string">&quot;getSharedPreferences&quot;</span>, e);</span><br><span class="line">               &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                   Log.w(TAG, <span class="string">&quot;getSharedPreferences&quot;</span>, e);</span><br><span class="line">               &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                   IoUtils.closeQuietly(str);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125; <span class="keyword">catch</span> (ErrnoException e) &#123;</span><br><span class="line">       &#125;</span><br><span class="line">       mLoaded = <span class="literal">true</span>;			<span class="comment">//Loaded标志设置为&quot;加载了&quot;</span></span><br><span class="line">       <span class="keyword">if</span> (map != <span class="literal">null</span>) &#123;</span><br><span class="line">           mMap = map;			<span class="comment">//将SharedPreferences的值取出来存到当前类的map中.</span></span><br><span class="line">           mStatTimestamp = stat.st_mtime;</span><br><span class="line">           mStatSize = stat.st_size;</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           mMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;String, Object&gt;();</span><br><span class="line">       &#125;</span><br><span class="line">       notifyAll();  					<span class="comment">//唤醒</span></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>主要作用是取出Sp中的数据,并解析成Map.将Map赋值给当前类中的ArrayMap.</p>
<h3 id="至此getSharedPreferences构部分造完毕"><a href="#至此getSharedPreferences构部分造完毕" class="headerlink" title="至此getSharedPreferences构部分造完毕"></a>至此getSharedPreferences构部分造完毕</h3><p>梳理一下流程:</p>
<p><strong>getSharedPreferences(name,mode)</strong></p>
<p>1.根据包名找到对应的ArrayMap</p>
<p>2.从ArrayMap中根据name找到对应的SharedPreferences</p>
<p>3.返回SharedPreferences<br>(如果没有,就从新创建一个)</p>
<p><strong>new SharedPreferencesImpl(prefsFile, mode);</strong></p>
<p>1.创子线程加锁解析出Xml文件内容到Map.</p>
<hr>
<h3 id="SharedPreferences的监听器"><a href="#SharedPreferences的监听器" class="headerlink" title="SharedPreferences的监听器"></a>SharedPreferences的监听器</h3><p>使用一个弱引用的监听器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> WeakHashMap&lt;OnSharedPreferenceChangeListener, Object&gt; mListeners =</span><br><span class="line">          <span class="keyword">new</span> <span class="title class_">WeakHashMap</span>&lt;OnSharedPreferenceChangeListener, Object&gt;();</span><br></pre></td></tr></table></figure>

<p>ps:弱引用不管内存是否足够都会被垃圾回收器回收</p>
<p>提供两个注册监听和取消注册的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerOnSharedPreferenceChangeListener</span><span class="params">(OnSharedPreferenceChangeListener listener)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="built_in">this</span>) &#123;</span><br><span class="line">        mListeners.put(listener, mContent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">unregisterOnSharedPreferenceChangeListener</span><span class="params">(OnSharedPreferenceChangeListener listener)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="built_in">this</span>) &#123;</span><br><span class="line">        mListeners.remove(listener);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>看到这种添加监听者和取消监听者的第一反应就是,这是不是观察者?</p>
<p>没错!</p>
<p>这就是在设置和取消观察者.</p>
<p>什么时候调用监听器?</p>
<p>在apply和commit方法中会调用监听器.通知监听器我数据改变了.你想干啥就干啥吧!看apply&#x2F;commit部分的通知方法是这个样子滴:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">notifyListeners(mcr);</span><br></pre></td></tr></table></figure>

<p>具体的监听行为就要自己实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">OnSharedPreferenceChangeListener</span><br></pre></td></tr></table></figure>

<p>接口.</p>
<h3 id="至此监听器部分完毕"><a href="#至此监听器部分完毕" class="headerlink" title="至此监听器部分完毕"></a>至此监听器部分完毕</h3><hr>
<h3 id="get方法"><a href="#get方法" class="headerlink" title="get方法:"></a>get方法:</h3><p>例子:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Nullable</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">getString</span><span class="params">(String key, <span class="meta">@Nullable</span> String defValue)</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        awaitLoadedLocked();</span><br><span class="line">        <span class="type">String</span> <span class="variable">v</span> <span class="operator">=</span> (String)mMap.get(key);</span><br><span class="line">        <span class="keyword">return</span> v != <span class="literal">null</span> ? v : defValue;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">awaitLoadedLocked</span><span class="params">()</span> &#123;</span><br><span class="line">       <span class="keyword">if</span> (!mLoaded) &#123;</span><br><span class="line">           <span class="comment">// Raise an explicit StrictMode onReadFromDisk for this</span></span><br><span class="line">           <span class="comment">// thread, since the real read will be in a different</span></span><br><span class="line">           <span class="comment">// thread and otherwise ignored by StrictMode.</span></span><br><span class="line">           为此线程提高一个显式的StrictMode onReadFromDisk，因为真正的读</span><br><span class="line">           </span><br><span class="line">           取将位于不同的线程中，否则将被StrictMode忽略。</span><br><span class="line">           BlockGuard.getThreadPolicy().onReadFromDisk();</span><br><span class="line">       &#125;</span><br><span class="line">       </span><br><span class="line">StrictMode是严苛模式.帮助开发者发现问题,有IOStrictMode与VmSrictMode</span><br><span class="line"></span><br><span class="line">       <span class="title function_">while</span> <span class="params">(!mLoaded)</span> &#123;<span class="comment">//没被加载执行</span></span><br><span class="line">           <span class="keyword">try</span> &#123;</span><br><span class="line">               wait();     													<span class="comment">//在loadFromDiskLocked中有唤醒操作</span></span><br><span class="line">           &#125; <span class="keyword">catch</span> (InterruptedException unused) &#123;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>为此线程提高一个显式的StrictMode onReadFromDisk，因为真正的读取将位于不同的线程中，否则将被StrictMode忽略。</p>
<hr>
<h3 id="对SharedPreferences的修改"><a href="#对SharedPreferences的修改" class="headerlink" title="对SharedPreferences的修改"></a>对SharedPreferences的修改</h3><p>提供Editer接口,接口中有如下方法</p>
<ul>
<li><pre><code>  Editor putString(String key, @Nullable String value);
</code></pre>
</li>
<li><pre><code>    Editor putStringSet(String key, @Nullable Set&lt;String&gt; values);
</code></pre>
</li>
<li><pre><code>Editor putInt(String key, int value);
</code></pre>
</li>
<li><pre><code>  Editor putLong(String key, long value);
</code></pre>
</li>
<li><pre><code>       Editor putFloat(String key, float value);
</code></pre>
</li>
<li><pre><code>             Editor putBoolean(String key, boolean value);
</code></pre>
</li>
<li><pre><code>                  Editor remove(String key);
</code></pre>
</li>
<li><pre><code>                          Editor clear();
</code></pre>
</li>
<li><pre><code>                                  boolean commit();
</code></pre>
</li>
<li><pre><code>                                     void apply();
</code></pre>
</li>
</ul>
<blockquote>
<p>解析putString类;</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">public</span> Editor <span class="title function_">putString</span><span class="params">(String key, <span class="meta">@Nullable</span> String value)</span> &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">          mModified.put(key, value);</span><br><span class="line">          <span class="keyword">return</span> <span class="built_in">this</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>mModified是Editor类中的HashMap成员变量,每次的put方法,都会将键和值压入Map中</p>
<blockquote>
<p>解析apply类与commit类</p>
</blockquote>
<p>官方文档说如果需要有返回值用commit,否则用apply()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">MemoryCommitResult</span> <span class="variable">mcr</span> <span class="operator">=</span> commitToMemory();	<span class="comment">//将要提交的Editer中的数据赋值给SP中的数据</span></span><br><span class="line">            <span class="keyword">final</span> <span class="type">Runnable</span> <span class="variable">awaitCommit</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            mcr.writtenToDiskLatch.await();		<span class="comment">//此时被阻塞. mcr中的方法.setDiskWriteResult(boolean result),</span></span><br><span class="line">                            									<span class="comment">//使countdownLatch减一</span></span><br><span class="line">                        &#125; <span class="keyword">catch</span> (InterruptedException ignored) &#123;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">		</span><br><span class="line">            QueuedWork.add(awaitCommit);						<span class="comment">//线程池添加任务</span></span><br><span class="line"></span><br><span class="line">            <span class="type">Runnable</span> <span class="variable">postWriteRunnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                        awaitCommit.run();					</span><br><span class="line">                        QueuedWork.remove(awaitCommit); 	 <span class="comment">//作用是向Disk中写,数据, awaitCommit.run是等待写完成(我猜),完成以后从队列删除,,,</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line"></span><br><span class="line">            SharedPreferencesImpl.<span class="built_in">this</span>.enqueueDiskWrite(mcr, postWriteRunnable);  </span><br><span class="line">            </span><br><span class="line">            -------------------------------------------------------</span><br><span class="line">            区别在这↑</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Okay to notify the listeners before it&#x27;s hit disk</span></span><br><span class="line">            <span class="comment">// because the listeners should always get the same</span></span><br><span class="line">            <span class="comment">// SharedPreferences instance back, which has the		</span></span><br><span class="line">            <span class="comment">// changes reflected in memory.</span></span><br><span class="line">            notifyListeners(mcr);</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br></pre></td></tr></table></figure>



<p>首先看appy中的第一句代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">MemoryCommitResult</span> <span class="variable">mcr</span> <span class="operator">=</span> commitToMemory();	</span><br></pre></td></tr></table></figure>

<p>这里的commitToMemory方法.内部逻辑是,判断mModified中的key和value在 Shapreference中的mMap中是否已经存在.找到不存在的值,put到mMap中.(美其名曰存到内存中).剩下apply部分的代码主要是将其存储到 Disk中</p>
<blockquote>
<p>以下是commit()</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">commit</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">MemoryCommitResult</span> <span class="variable">mcr</span> <span class="operator">=</span> commitToMemory();		<span class="comment">//提交到数据,Editer与Sp数据统一</span></span><br><span class="line">    SharedPreferencesImpl.<span class="built_in">this</span>.enqueueDiskWrite(	<span class="comment">//第二个参数为空.在apply中传一个Runnable</span></span><br><span class="line">        mcr, <span class="literal">null</span> <span class="comment">/* sync write on this thread okay */</span>);	</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        mcr.writtenToDiskLatch.await();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    notifyListeners(mcr);</span><br><span class="line">    <span class="keyword">return</span> mcr.writeToDiskResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>commit与apply的差别在于</p>
<p>**  enqueueDiskWrite**<br>下面看他的实现</p>
<blockquote>
<p>enqueueDiskWrite</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">enqueueDiskWrite</span><span class="params">(<span class="keyword">final</span> MemoryCommitResult mcr,</span></span><br><span class="line"><span class="params">                                  <span class="keyword">final</span> Runnable postWriteRunnable)</span> &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Runnable</span> <span class="variable">writeToDiskRunnable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Runnable</span>() &#123;</span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">                    <span class="keyword">synchronized</span> (mWritingToDiskLock) &#123;</span><br><span class="line">                        writeToFile(mcr);						<span class="comment">//开始写数据到硬盘,</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">synchronized</span> (SharedPreferencesImpl.<span class="built_in">this</span>) &#123;</span><br><span class="line">                        mDiskWritesInFlight--;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (postWriteRunnable != <span class="literal">null</span>) &#123;</span><br><span class="line">                        postWriteRunnable.run();			<span class="comment">//中途会被await();</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">isFromSyncCommit</span> <span class="operator">=</span> (postWriteRunnable == <span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Typical #commit() path with fewer allocations, doing a write on</span></span><br><span class="line">        <span class="comment">// the current thread.</span></span><br><span class="line">        <span class="keyword">if</span> (isFromSyncCommit) &#123;			<span class="comment">//如果从commit中调用过来的,直接开始写.</span></span><br><span class="line">            <span class="type">boolean</span> <span class="variable">wasEmpty</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">synchronized</span> (SharedPreferencesImpl.<span class="built_in">this</span>) &#123;</span><br><span class="line">                wasEmpty = mDiskWritesInFlight == <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (wasEmpty) &#123;</span><br><span class="line">                writeToDiskRunnable.run();					<span class="comment">//&lt;&lt;&lt;&lt;&lt;这里开始</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        QueuedWork.singleThreadExecutor().execute(writeToDiskRunnable);  		<span class="comment">//不是commit调用过来的.用线程池写</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>apply是用线程池写数据,<br>commit是直接开一个写线程,直接写！且立即写.</p>
<hr>
<p>终于整完了!</p>

        </div>

        

        
            <ul class="post-tags-box">
                
                    <li class="tag-item">
                        <a href="/tags/Android/">#Android</a>&nbsp;
                    </li>
                
                    <li class="tag-item">
                        <a href="/tags/SharedPreferences/">#SharedPreferences</a>&nbsp;
                    </li>
                
            </ul>
        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2020/05/26/iHandy%E9%9D%A2%E7%BB%8F/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">iHandy面经</span>
                                <span class="post-nav-item">Prev posts</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2020/02/28/%E8%A3%85%E9%A5%B0%E6%A8%A1%E5%BC%8F/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">装饰模式</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Keep Team</a>
        </div>
        
        <div class="theme-info info-item">
            Powered by <a target="_blank" href="https://hexo.io">Hexo</a>&nbsp;|&nbsp;Theme&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.5</a>
        </div>
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    

    <div class="image-viewer-container">
    <img src="">
</div>


    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>








<div class="post-scripts">
    
</div>



</body>
</html>
